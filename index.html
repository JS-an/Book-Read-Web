<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Reading Web</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/main.css">
</head>

<body>

    <div class="container">
        <div class="layout">
            <div class="content" id="content">
                <h3 class="content-title" id="contentTitle"></h3>
                <div class="content-text" id="contentText"></div>
            </div>
            <div class="nav-buttons">
                <button id="prevChapter">ä¸Šä¸€ç« </button>
                <button id="nextChapter">ä¸‹ä¸€ç« </button>
            </div>
        </div>
    </div>

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3 id="sidebarTitle">åŠŸèƒ½é¢æ¿</h3>
            <button class="sidebar-close" onclick="closeSidebar()">
                <svg viewBox="0 0 24 24" width="24" height="24">
                    <path fill="currentColor"
                        d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
                </svg>
            </button>
        </div>
        <div id="sidebarContent" class="sidebar-content">
            <!-- 1. è®¾ç½®é¢æ¿ -->
            <div id="settingsPanel" class="sidebar-panel">
                <div class="settings-container">
                    <div class="settings-group">
                        <h4>æ–‡æœ¬è®¾ç½®</h4>
                        <div class="setting-item">
                            <label>å­—ä½“å¤§å°: <span id="fontSizeValue">18px</span></label>
                            <input type="range" id="fontSize" min="12" max="32" value="18" oninput="updateFontSize(this.value)">
                        </div>
                        <div class="setting-item">
                            <label>è¡Œé—´è·: <span id="lineHeightValue">1.8</span></label>
                            <input type="range" id="lineHeight" min="1.2" max="3" step="0.1" value="1.8" oninput="updateLineHeight(this.value)">
                        </div>
                        <div class="setting-item">
                            <label>å­—ä½“é€‰æ‹©:</label>
                            <select id="fontFamily" onchange="updateFontFamily(this.value)">
                                <option value="Noto Serif SC" selected>æ€æºå®‹ä½“</option>
                                <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                                <option value="SimSun">å®‹ä½“</option>
                                <option value="KaiTi">æ¥·ä½“</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h4>é¡µé¢è®¾ç½®</h4>
                        <div class="setting-item">
                            <label>é¡µé¢å®½åº¦:</label>
                            <select id="pageWidth" onchange="updatePageWidth(this.value)">
                                <option value="auto" selected>è‡ªåŠ¨</option>
                                <option value="400px">è¿·ä½ </option>
                                <option value="600px">å°</option>
                                <option value="800px">ä¸­</option>
                                <option value="1000px">å¤§</option>
                                <option value="1200px">å·¨å¤§</option>
                                <option value="1400px">è¶…å¤§</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>æ®µè½é—´è·:</label>
                            <input type="range" id="paragraphSpacing" min="0.5" max="3" step="0.1" value="1.5" oninput="updateParagraphSpacing(this.value)">
                        </div>
                        <div class="setting-item">
                            <label>ç¿»é¡µæ¨¡å¼:</label>
                            <select id="pageMode" onchange="updatePageMode(this.value)">
                                <option value="autoAppend">æ»šåŠ¨è‡ªåŠ¨æ‹¼æ¥</option>
                                <option value="button" selected>æŒ‰é’®ç¿»é¡µ</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h4>è‡ªåŠ¨æ»šåŠ¨</h4>
                        <div class="setting-item">
                            <label>æ»šåŠ¨é€Ÿåº¦:</label>
                            <input type="range" id="scrollSpeed" min="10" max="150" value="40" oninput="updateScrollSpeed(this.value)">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. æ–‡ä»¶è¾“å…¥é¢æ¿ -->
            <div id="fileInputPanel" class="sidebar-panel">
                <div class="file-input-container">
                    <div class="file-input-wrapper">
                        <input type="file" id="sidebarFileInput" accept=".txt">
                        <p class="file-hint">æ”¯æŒ.txtæ ¼å¼ï¼Œæœ€å¤§100MB</p>
                    </div>
                    <div class="recent-files">
                        <ul id="sidebarRecentList" class="recent-list"></ul>
                    </div>
                </div>
            </div>

            <!-- 3. ç« èŠ‚ç›®å½•é¢æ¿ -->
            <div id="chapterListPanel" class="sidebar-panel">
                <div class="chapter-list-container">
                    <input type="text" id="chapterSearchInput" class="sidebar-input" placeholder="æœç´¢ç« èŠ‚...">
                    <ul id="sidebarChapterList" class="chapter-list"></ul>
                </div>
            </div>

            <!-- 4. ä¸»é¢˜è®¾ç½®é¢æ¿ -->
            <div id="themePanel" class="sidebar-panel">
                <div class="theme-list" id="themeListContent">
                    <!-- å†…å®¹ä¼šåœ¨generateThemeListå‡½æ•°ä¸­åŠ¨æ€å¡«å…… -->
                </div>
            </div>

            <!-- 5. æœ€è¿‘é˜…è¯»ç« èŠ‚é¢æ¿ -->
            <div id="recentChaptersPanel" class="sidebar-panel">
                <div class="recent-chapters-container" id="recentChaptersContent">
                    <!-- å†…å®¹ä¼šåœ¨showRecentChapterså‡½æ•°ä¸­åŠ¨æ€å¡«å…… -->
                </div>
            </div>

            <!-- 6. ä¹¦ç­¾é¢æ¿ -->
            <div id="bookmarksPanel" class="sidebar-panel">
                <div class="bookmarks-container" id="bookmarksContent">
                    <!-- å†…å®¹ä¼šåœ¨showBookmarkså‡½æ•°ä¸­åŠ¨æ€å¡«å…… -->
                </div>
            </div>
        </div>
    </div>

    <div class="function-buttons">
        <button id="fileInputButton" class="function-btn" onclick="showFileInput()" title="æ‰“å¼€æ–‡ä»¶">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
            </svg>
        </button>
        <button id="chapterListButton" class="function-btn" onclick="showChapterList()" title="æŸ¥çœ‹ç›®å½•">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor" d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" />
            </svg>
        </button>
        <button id="themeButton" class="function-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor"
                    d="M12,18C11.11,18 10.26,17.8 9.5,17.45C11.56,16.5 13,14.42 13,12C13,9.58 11.56,7.5 9.5,6.55C10.26,6.2 11.11,6 12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18M20,8.69V4H15.31L12,0.69L8.69,4H4V8.69L0.69,12L4,15.31V20H8.69L12,23.31L15.31,20H20V15.31L23.31,12L20,8.69Z" />
            </svg>
        </button>
        <button id="autoScrollButton" class="function-btn" onclick="toggleAutoScroll()" title="è‡ªåŠ¨æ»šåŠ¨">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor"
                    d="M13,16V8H15L12,5L9,8H11V16H9L12,19L15,16H13M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2Z" />
            </svg>
        </button>
        <button id="bookmarkButton" class="function-btn" onclick="toggleBookmark()" title="æ·»åŠ ä¹¦ç­¾">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor" d="M17,3H7A2,2 0 0,0 5,5V21L12,18L19,21V5C19,3.89 18.1,3 17,3Z" />
            </svg>
        </button>
        <button id="bookmarkButton" class="function-btn" onclick="showBookmarks()" title="æŸ¥çœ‹ä¹¦ç­¾">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor"
                    d="M19,2H14.82C14.4,0.84 13.3,0 12,0C10.7,0 9.6,0.84 9.18,2H5C3.9,2 3,2.9 3,4V20C3,21.1 3.9,22 5,22H19C20.1,22 21,21.1 21,20V4C21,2.9 20.1,2 19,2M12,2C12.55,2 13,2.45 13,3C13,3.55 12.55,4 12,4C11.45,4 11,3.55 11,3C11,2.45 11.45,2 12,2M7,7H17V9H7V7M7,11H17V13H7V11M7,15H17V17H7V15Z" />
            </svg>
        </button>
        <button id="recentChaptersButton" class="function-btn" onclick="showRecentChapters()" title="æœ€è¿‘é˜…è¯»">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor"
                    d="M13.5,8H12V13L16.28,15.54L17,14.33L13.5,12.25V8M13,3A9,9 0 0,0 4,12H1L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3" />
            </svg>
        </button>
        <button id="settingsButton" class="function-btn" onclick="showSettings()" title="é˜…è¯»è®¾ç½®">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor"
                    d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
            </svg>
        </button>
        <button id="fullscreenButton" class="function-btn" onclick="toggleFullscreen()" title="å…¨å±é˜…è¯»">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor" d="M5,5H10V7H7V10H5V5M14,5H19V10H17V7H14V5M17,14H19V19H14V17H17V14M10,17V19H5V14H7V17H10Z" />
            </svg>
        </button>
    </div>

    <div class="progress-tip" id="progressTip">
        <div class="progress-tip-box">
            <span>å·²è¯»å®Œ <span id="readProgress">0</span>%</span>
            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="shortcut-tip">
        å¿«æ·é”®ï¼šâ† ä¸Šä¸€ç«  | â†’ ä¸‹ä¸€ç« 
    </div>

    <div id="loadingIndicator" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <div style="color: white; margin-top: 20px;">æ­£åœ¨åŠ è½½æ–‡ä»¶...</div>
    </div>

    <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

    <script src="js/utils.js"></script>
    <script>
        let novelName = ''; // æ–‡ä»¶å
        let chapters = []; // ç« èŠ‚åˆ—è¡¨
        let currentChapterIndex = 0; // å½“å‰ç« èŠ‚ç´¢å¼•
        let currentChapterContent = []; // å½“å‰ç« èŠ‚å†…å®¹
        let autoScrollSpeed = 50; // è‡ªåŠ¨æ»šåŠ¨é€Ÿåº¦
        let pageMode = 'autoAppend'; // ç¿»é¡µæ¨¡å¼

        const MAX_RECENT_FILES = 100; // æœ€å¤§æœ€è¿‘æ–‡ä»¶æ•°

        //#region å¿«æ·é”®
        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'ArrowLeft':
                    showChapter(currentChapterIndex - 1);
                    break;
                case 'ArrowRight':
                    showChapter(currentChapterIndex + 1);
                    break;
            }
        });

        // æ˜¾ç¤ºå¿«æ·é”®æç¤º
        function showShortcutTip() {
            // å¦‚æœå±å¹•å°äº768pxï¼Œåˆ™ä¸æ˜¾ç¤ºå¿«æ·é”®æç¤º
            if (window.innerWidth < 768) return;
            const tip = document.querySelector('.shortcut-tip');
            tip.style.display = 'block';

            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                tip.style.display = 'none';
            }, 5000);
        }
        //#endregion

        //#region ä¸»é¢˜åŠŸèƒ½
        let currentTheme = storageUtil.get('theme') || 'light'; // å½“å‰ä¸»é¢˜
        document.documentElement.setAttribute('data-theme', currentTheme);

        // æ„å»ºä¸»é¢˜åˆ—è¡¨
        const generateThemeList = () => {
            const themes = {
                light: { name: 'æç®€çº¯ç™½', icon: 'â˜€ï¸' },
                dark: { name: 'æç®€æ·±é»‘', icon: 'ğŸŒ™' },
                sepia: { name: 'æç®€æŠ¤çœ¼', icon: 'ğŸ“–' },
                green: { name: 'æç®€æ£®ç»¿', icon: 'ğŸŒ²' },
                'dark-green': { name: 'æç®€å¢¨ç»¿', icon: 'ğŸŒ¿' },
                blue: { name: 'æç®€æµ·è“', icon: 'ğŸŒŠ' },
                'dark-blue': { name: 'æç®€æ·±è“', icon: 'ğŸŒŠ' },
                pink: { name: 'æç®€æ¨±ç²‰', icon: 'ğŸ€' },
                purple: { name: 'æç®€å¹»ç´«', icon: 'ğŸŒ¸' },
            };

            // æ›´æ–°ä¸»é¢˜åˆ—è¡¨å†…å®¹
            const themeListContent = document.getElementById('themeListContent');
            themeListContent.innerHTML = Object.entries(themes).map(([id, theme]) => `
                <div class="theme-option ${currentTheme === id ? 'active' : ''}" 
                    onclick="applyTheme('${id}')">
                    <div class="theme-sample ${id}"></div>
                    <span>${theme.name} ${theme.icon}</span>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºä¸»é¢˜é¢æ¿
        function toggleTheme() {
            openSidebar('ä¸»é¢˜è®¾ç½®', 'theme');
        }

        // æ·»åŠ åº”ç”¨ä¸»é¢˜å‡½æ•°
        function applyTheme(themeId) {
            currentTheme = themeId;
            document.documentElement.setAttribute('data-theme', themeId);
            storageUtil.set('theme', themeId);
            generateThemeList()
            closeSidebar();
        }
        //#endregion

        //#region å…¨å±åŠŸèƒ½
        // å…¨å±åŠŸèƒ½
        async function toggleFullscreen() {
            try {
                if (!document.fullscreenElement &&
                    !document.webkitFullscreenElement &&
                    !document.mozFullScreenElement) {
                    // è¿›å…¥å…¨å±
                    const docEl = document.documentElement;
                    const requestMethod = docEl.requestFullscreen ||
                        docEl.webkitRequestFullscreen ||
                        docEl.mozRequestFullScreen;

                    if (requestMethod) {
                        await requestMethod.call(docEl);
                        document.body.classList.add('fullscreen-mode');
                        updateFullscreenButton(true);
                    }
                } else {
                    // é€€å‡ºå…¨å±
                    const exitMethod = document.exitFullscreen ||
                        document.webkitExitFullscreen ||
                        document.mozCancelFullScreen;

                    if (exitMethod) {
                        await exitMethod.call(document);
                    }
                }
            } catch (error) {
                console.error('å…¨å±åˆ‡æ¢å¤±è´¥:', error);
                // å›æ»šçŠ¶æ€
                document.body.classList.remove('fullscreen-mode');
                updateFullscreenButton(false);
            }
        }

        // æ›´æ–°å…¨å±æŒ‰é’®çŠ¶æ€
        function updateFullscreenButton(isFullscreen) {
            const button = document.querySelector('#fullscreenButton');
            if (!button) return;

            if (isFullscreen) {
                button.innerHTML = `
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" 
                            d="M14,14H19V16H16V19H14V14M5,14H10V19H8V16H5V14M8,5H10V10H5V8H8V5M19,8V10H14V5H16V8H19Z" />
                    </svg>
                `;
                button.title = "é€€å‡ºå…¨å±";
            } else {
                button.innerHTML = `
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" 
                              d="M5,5H10V7H7V10H5V5M14,5H19V10H17V7H14V5M17,14H19V19H14V17H17V14M10,17V19H5V14H7V17H10Z" />
                    </svg>
                `;
                button.title = "å…¨å±é˜…è¯»";
            }
        }

        // ç›‘å¬å…¨å±å˜åŒ–äº‹ä»¶
        function handleFullscreenChange() {
            const isFullscreen = !!(document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement);

            document.body.classList.toggle('fullscreen-mode', isFullscreen);
            updateFullscreenButton(isFullscreen);
        }

        // æ·»åŠ å…¨å±ç›¸å…³äº‹ä»¶ç›‘å¬
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);

        // æ·»åŠ  ESC é”®é€€å‡ºå…¨å±çš„å¤„ç†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.body.classList.contains('fullscreen-mode')) {
                toggleFullscreen();
            }
        });
        //#endregion

        //#region è‡ªåŠ¨æ»šåŠ¨
        let autoScrollInterval; // è‡ªåŠ¨æ»šåŠ¨è®¡æ—¶å™¨
        let isAutoScrolling = false; // è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€

        // åœæ­¢è‡ªåŠ¨æ»šåŠ¨
        function stopAutoScroll() {
            clearInterval(autoScrollInterval);
            isAutoScrolling = false;
            const autoScrollBtn = document.querySelector('#autoScrollButton');
            if (autoScrollBtn) {
                autoScrollBtn.style.backgroundColor = 'var(--card-bg)';
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨
        function toggleAutoScroll() {
            if (isAutoScrolling) {
                stopAutoScroll()
            } else {
                const autoScrollBtn = document.querySelector('#autoScrollButton');
                isAutoScrolling = true;
                autoScrollBtn && (autoScrollBtn.style.backgroundColor = 'var(--active-bg)');
                autoScrollInterval = setInterval(() => {
                    const content = document.querySelector('.content');
                    content.scrollTop += autoScrollSpeed / 40;

                    // å½“æ»šåŠ¨åˆ°åº•éƒ¨æ—¶ï¼Œè‡ªåŠ¨ç¿»é¡µ
                    if (content.scrollTop + content.clientHeight >= content.scrollHeight) {
                        if (pageMode === 'autoAppend') {
                            (currentChapterIndex < chapters.length - 1) ? appendNextChapter() : stopAutoScroll()
                        } else {
                            setTimeout(() => {
                                (currentChapterIndex < chapters.length - 1) ? showChapter(currentChapterIndex + 1) : stopAutoScroll()
                            }, 3000)
                        }
                    }
                }, 16);
            }
        }
        //#endregion

        //#region é˜…è¯»è¿›åº¦
        // æ›´æ–°é˜…è¯»è¿›åº¦
        function updateReadProgress() {
            const totalChapters = chapters.length;
            if (totalChapters === 0) return;

            const progress = Math.round((currentChapterIndex / totalChapters) * 100);
            document.getElementById('readProgress').textContent = progress;

            // æ›´æ–°è¿›åº¦æ¡
            const progressBar = document.querySelector('.progress-bar-fill');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
        }

        // ä¿å­˜é˜…è¯»è¿›åº¦
        function saveReadingProgress() {
            const progress = {
                novelName: novelName,
                fileName: chapters[currentChapterIndex]?.title || '',
                chapterIndex: currentChapterIndex,
                scrollPosition: document.querySelector('.content').scrollTop,
                timestamp: new Date().getTime(),
                percentage: Math.round((currentChapterIndex / chapters.length) * 100),
                lastChapterTitle: chapters[currentChapterIndex]?.title
            };
            storageUtil.set('readingProgress', progress);
        }

        // æ¢å¤é˜…è¯»è¿›åº¦
        async function restoreReadingProgress() {
            const progress = storageUtil.get('readingProgress');
            if (progress) {
                await loadRecentFile(progress.novelName);
                showChapter(progress.chapterIndex);
            }
        }
        //#endregion

        //#region æ ‡ç­¾
        // æ·»åŠ æ ‡ç­¾
        function toggleBookmark() {
            const currentChapter = chapters[currentChapterIndex];
            if (!currentChapter) return;

            const scrollPosition = document.querySelector('.content').scrollTop;
            const bookmarks = storageUtil.get('bookmarks', []);

            const existingBookmark = bookmarks.findIndex(b =>
                b.chapterIndex === currentChapterIndex);

            if (existingBookmark !== -1) {
                bookmarks.splice(existingBookmark, 1);
                Swal.fire({
                    title: 'å·²åˆ é™¤ä¹¦ç­¾',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            } else {
                bookmarks.push({
                    novelName: novelName,
                    chapterIndex: currentChapterIndex,
                    chapterTitle: currentChapter.title,
                    scrollPosition: scrollPosition,
                    timestamp: new Date().getTime()
                });
                Swal.fire({
                    title: 'å·²æ·»åŠ ä¹¦ç­¾',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            }

            storageUtil.set('bookmarks', bookmarks);
        }

        // å±•ç¤ºæ ‡ç­¾åˆ—è¡¨
        function showBookmarks() {
            const bookmarks = storageUtil.get('bookmarks', []);

            const bookmarksContent = document.getElementById('bookmarksContent');
            bookmarksContent.innerHTML = bookmarks.length === 0 ?
                '<div class="empty-message">æš‚æ— ä¹¦ç­¾</div>' :
                `
                    <div class="bookmarks-list">
                        ${bookmarks.map((bookmark, index) => `
                            <div class="bookmark-item">
                                <div class="bookmark-content" onclick="gotoBookmark(${index})">
                                    <div class="bookmark-title">${bookmark.chapterTitle}</div>
                                    <div class="bookmark-time">${new Date(bookmark.timestamp).toLocaleString()}</div>
                                </div>
                                <button class="delete-btn" onclick="deleteBookmark(${index})">
                                    <svg viewBox="0 0 24 24" width="16" height="16">
                                        <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
            `;
            openSidebar('ä¹¦ç­¾åˆ—è¡¨', 'bookmarks');
        }

        // è·³è½¬æ ‡ç­¾
        async function gotoBookmark(index) {
            const bookmarks = storageUtil.get('bookmarks', []);
            const bookmark = bookmarks[index];
            if (bookmark.novelName !== novelName) {
                await loadRecentFile(bookmark.novelName);
            }
            if (bookmark) {
                showChapter(bookmark.chapterIndex);
                // Swal.close();
            }
            closeSidebar();
        }

        // åˆ é™¤æ ‡ç­¾
        function deleteBookmark(index) {
            const bookmarks = storageUtil.get('bookmarks', []);
            bookmarks.splice(index, 1);
            storageUtil.set('bookmarks', bookmarks);
            showBookmarks();
        }
        //#endregion

        //#region é˜…è¯»æ—¶é—´
        let readingStartTime = null;
        let totalReadingTime = parseInt(storageUtil.get('totalReadingTime', 0));

        // æ˜¾ç¤ºé˜…è¯»æ—¶é—´
        function showReadingTime() {
            const timeTip = document.createElement('div');
            timeTip.textContent = `æ€»é˜…è¯»æ—¶é—´ï¼š${formatReadingTime(totalReadingTime)}`;
            document.querySelector('#progressTip').appendChild(timeTip);
        }

        // å¼€å§‹é˜…è¯»
        function startReadingTimer() {
            if (!readingStartTime) {
                readingStartTime = new Date();
            }
        }

        // åœæ­¢é˜…è¯»ä¸”ä¿æŒé˜…è¯»æ—¶é—´
        function stopReadingTimer() {
            if (readingStartTime) {
                const endTime = new Date();
                const timeSpent = Math.floor((endTime - readingStartTime) / 1000);
                totalReadingTime += timeSpent;
                storageUtil.set('totalReadingTime', totalReadingTime.toString());
                readingStartTime = null;
            }
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopReadingTimer();
            } else {
                startReadingTimer();
            }
        });
        //#endregion

        //#region æœ€è¿‘é˜…è¯»
        // æ·»åŠ ä¿å­˜æœ€è¿‘é˜…è¯»ç« èŠ‚çš„å‡½æ•°
        function saveRecentChapter() {
            try {
                const recentChapters = storageUtil.get('recentChapters', []);
                if (!novelName || !chapters) return;
                const currentChapter = {
                    novelName: novelName,
                    title: chapters[currentChapterIndex].title,
                    chapterIndex: currentChapterIndex,
                    fileName: document.querySelector('.content-title').textContent, // å½“å‰æ–‡ä»¶å
                    time: new Date().getTime()
                };

                // ç§»é™¤ç›¸åŒä¹¦
                const filteredChapters = recentChapters.filter(chapter =>
                    chapter.novelName !== currentChapter.novelName
                );

                // æ·»åŠ åˆ°å¼€å¤´
                filteredChapters.unshift(currentChapter);

                storageUtil.set('recentChapters', filteredChapters);
            } catch (error) {
                console.error('ä¿å­˜æœ€è¿‘é˜…è¯»ç« èŠ‚å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæœ€è¿‘é˜…è¯»åˆ—è¡¨
        function showRecentChapters() {
            const recentChapters = storageUtil.get('recentChapters', []);

            // æ›´æ–°æœ€è¿‘é˜…è¯»ç« èŠ‚å†…å®¹
            const recentChaptersContent = document.getElementById('recentChaptersContent');
            recentChaptersContent.innerHTML = recentChapters.length === 0 ?
                '<div class="empty-message">æš‚æ— é˜…è¯»è®°å½•</div>' :
                `<div class="recent-list">
                    ${recentChapters.map((chapter, index) => `
                        <div class="recent-item">
                            <div class="recent-item-info" onclick="jumpToRecentChapter(${index})">
                                <div class="recent-item-title">${chapter.novelName}</div>
                                <div class="recent-item-time">${formatTime(chapter.time)}</div>
                                <div class="recent-item-file">${chapter.title}</div>
                            </div>
                            <button class="delete-btn" onclick="deleteRecentChapter(${index}); event.stopPropagation();">
                                <svg viewBox="0 0 24 24" width="16" height="16">
                                    <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                </svg>
                            </button>
                        </div>
                    `).join('')}
                </div>`;

            // æ‰“å¼€ä¾§è¾¹æ ï¼Œæ˜¾ç¤ºæœ€è¿‘é˜…è¯»ç« èŠ‚é¢æ¿
            openSidebar('æœ€è¿‘é˜…è¯»', 'recentChapters');
        }

        // è·³è½¬åˆ°æœ€è¿‘é˜…è¯»çš„ç« èŠ‚
        async function jumpToRecentChapter(index) {
            const recentChapters = storageUtil.get('recentChapters', []);
            const chapter = recentChapters[index];

            if (chapter.novelName !== novelName) {
                await loadRecentFile(chapter.novelName);
            }

            if (chapter) {
                showChapter(chapter.chapterIndex);
            }
            closeSidebar();
        }

        // åˆ é™¤æœ€è¿‘é˜…è¯»ç« èŠ‚
        function deleteRecentChapter(index) {
            const recentChapters = storageUtil.get('recentChapters', []);
            recentChapters.splice(index, 1);
            storageUtil.set('recentChapters', recentChapters);
            showRecentChapters();
        }
        //#endregion

        //#region ä¾§è¾¹æ 
        // æ‰“å¼€ä¾§è¾¹æ 
        function openSidebar(title, panel) {
            document.getElementById('sidebarTitle').textContent = title;

            // éšè—æ‰€æœ‰é¢æ¿
            document.querySelectorAll('.sidebar-panel').forEach(p => {
                p.classList.remove('active');
            });

            // æ˜¾ç¤ºæŒ‡å®šçš„é¢æ¿
            const targetPanel = document.getElementById(panel + 'Panel');
            if (targetPanel) {
                targetPanel.classList.add('active');
            }

            document.getElementById('sidebar').classList.add('active');
            document.getElementById('sidebarOverlay').classList.add('active');
        }

        // å…³é—­ä¾§è¾¹æ 
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }
        //#endregion

        //#region è®¾ç½®åŠŸèƒ½
        // æ˜¾ç¤ºè®¾ç½®
        function showSettings() {
            const currentSettings = loadReaderSettings();

            // æ›´æ–°è®¾ç½®é¢æ¿ä¸­çš„å€¼
            document.getElementById('fontSizeValue').textContent = `${currentSettings.fontSize}px`;
            document.getElementById('fontSize').value = currentSettings.fontSize;

            document.getElementById('lineHeightValue').textContent = currentSettings.lineHeight;
            document.getElementById('lineHeight').value = currentSettings.lineHeight;

            // æ›´æ–°å­—ä½“é€‰æ‹©
            const fontFamilySelect = document.getElementById('fontFamily');
            Array.from(fontFamilySelect.options).forEach(option => {
                option.selected = option.value === currentSettings.fontFamily;
            });

            // æ›´æ–°é¡µé¢å®½åº¦é€‰æ‹©
            const pageWidthSelect = document.getElementById('pageWidth');
            Array.from(pageWidthSelect.options).forEach(option => {
                option.selected = option.value === currentSettings.pageWidth;
            });

            // æ›´æ–°æ®µè½é—´è·
            document.getElementById('paragraphSpacing').value = currentSettings.paragraphSpacing || 1.5;

            // æ›´æ–°ç¿»é¡µæ¨¡å¼
            const pageModeSelect = document.getElementById('pageMode');
            Array.from(pageModeSelect.options).forEach(option => {
                option.selected = option.value === (currentSettings.pageMode || 'autoAppend');
            });

            // æ›´æ–°æ»šåŠ¨é€Ÿåº¦
            document.getElementById('scrollSpeed').value = currentSettings.scrollSpeed || 50;

            // æ‰“å¼€ä¾§è¾¹æ ï¼Œæ˜¾ç¤ºè®¾ç½®é¢æ¿
            openSidebar('é˜…è¯»è®¾ç½®', 'settings');
        }

        // åŠ è½½ä¿å­˜çš„è®¾ç½®
        function loadReaderSettings() {
            const defaultSettings = {
                fontSize: '18',
                lineHeight: '1.8',
                fontFamily: 'Noto Serif SC',
                pageWidth: 'auto',
                pageMode: 'autoAppend'
            };

            try {
                const settings = storageUtil.get('readerSettings') || defaultSettings;
                const contentText = document.querySelector('.content-text');
                if (contentText) {
                    contentText.style.fontSize = `${settings.fontSize}px`;
                    contentText.style.lineHeight = settings.lineHeight;
                    contentText.style.fontFamily = settings.fontFamily;

                    const content = document.querySelector('.content');
                    if (content) {
                        content.style.maxWidth = settings.pageWidth === 'auto' ? 'none' : settings.pageWidth;
                    }
                }

                // åº”ç”¨ç¿»é¡µæ¨¡å¼è®¾ç½®
                pageMode = settings.pageMode || 'autoAppend';
                if (pageMode === 'autoAppend') {
                    enableAutoAppendMode();
                    // ç¡®ä¿å¯¼èˆªæŒ‰é’®åœ¨è‡ªåŠ¨æ‹¼æ¥æ¨¡å¼ä¸‹éšè—
                    document.querySelector('.nav-buttons').style.display = 'none';
                } else {
                    disableAutoAppendMode();
                    // ç¡®ä¿å¯¼èˆªæŒ‰é’®åœ¨æŒ‰é’®æ¨¡å¼ä¸‹æ˜¾ç¤º
                    document.querySelector('.nav-buttons').style.display = 'flex';
                }

                return settings;
            } catch (error) {
                console.error('åŠ è½½é˜…è¯»è®¾ç½®å¤±è´¥:', error);
                return defaultSettings;
            }
        }

        // æ›´æ–°å­—ä½“å¤§å°
        function updateFontSize(value) {
            const contentText = document.querySelector('.content-text');
            contentText.style.fontSize = `${value}px`;
            document.getElementById('fontSizeValue').textContent = `${value}px`;
            saveSettings();
        }

        // æ›´æ–°è¡Œé«˜
        function updateLineHeight(value) {
            const contentText = document.querySelector('.content-text');
            contentText.style.lineHeight = value;
            document.getElementById('lineHeightValue').textContent = value;
            saveSettings();
        }

        // æ›´æ–°å­—ä½“
        function updateFontFamily(value) {
            const contentText = document.querySelector('.content-text');
            contentText.style.fontFamily = value;
            saveSettings();
        }

        // æ›´æ–°é¡µé¢å®½åº¦
        function updatePageWidth(value) {
            const content = document.querySelector('.content');
            content.style.maxWidth = value === 'auto' ? 'none' : value;
            saveSettings();
        }

        // æ›´æ–°æ®µè½é—´è·
        function updateParagraphSpacing(value) {
            const contentText = document.querySelector('.content-text');
            contentText.style.marginBottom = `${value}em`;
            saveSettings();
        }

        // æ›´æ–°æ»šåŠ¨é€Ÿåº¦
        function updateScrollSpeed(value) {
            autoScrollSpeed = value;
            saveSettings();
        }

        // æ›´æ–°ç¿»é¡µæ¨¡å¼
        function updatePageMode(value) {
            pageMode = value;

            if (pageMode === 'autoAppend') {
                enableAutoAppendMode();
                document.querySelector('.nav-buttons').style.display = 'none'; // ç¡®ä¿å¯¼èˆªæŒ‰é’®åœ¨è‡ªåŠ¨æ‹¼æ¥æ¨¡å¼ä¸‹å§‹ç»ˆéšè—
            } else {
                disableAutoAppendMode();
                document.querySelector('.nav-buttons').style.display = 'flex'; // åœ¨éè‡ªåŠ¨æ‹¼æ¥æ¨¡å¼ä¸‹æ˜¾ç¤ºå¯¼èˆªæŒ‰é’®
            }
            saveSettings();
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            const settings = {
                fontSize: document.getElementById('fontSize').value,
                lineHeight: document.getElementById('lineHeight').value,
                fontFamily: document.getElementById('fontFamily').value,
                pageWidth: document.getElementById('pageWidth').value,
                paragraphSpacing: document.getElementById('paragraphSpacing').value,
                scrollSpeed: document.getElementById('scrollSpeed').value,
                pageMode: document.getElementById('pageMode')?.value || pageMode || 'autoAppend'
            };
            storageUtil.set('readerSettings', settings);
        }
        //#endregion

        //#region æ–‡ä»¶ä¸ç« èŠ‚
        // åˆ é™¤æ–‡ä»¶é¡¹ç›®
        function deleteRecentFile(index) {
            Swal.fire({
                title: 'ç¡®è®¤åˆ é™¤',
                text: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡é˜…è¯»è®°å½•å—ï¼Ÿ',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'åˆ é™¤',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    const recentFiles = storageUtil.get('recentFiles', []);
                    recentFiles.splice(index, 1);
                    storageUtil.set('recentFiles', recentFiles);
                    indexedDBUtil.deleteFile(recentFiles[index].name);
                    loadRecentFiles();

                    Swal.fire({
                        title: 'å·²åˆ é™¤',
                        text: 'é˜…è¯»è®°å½•å·²æˆåŠŸåˆ é™¤',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        // æ·»åŠ æ–‡ä»¶é¡¹ç›®
        async function addRecentFile(file, content) {
            try {
                const recentFiles = storageUtil.get('recentFiles', []);
                const newFile = {
                    name: file.name,
                    time: new Date().getTime(),
                    // é™åˆ¶ä¿å­˜çš„å†…å®¹å¤§å°ï¼Œåªä¿å­˜å‰ 1MB çš„å†…å®¹
                    // content: content.slice(0, 1024 * 1024)
                };

                // ç§»é™¤åŒåæ–‡ä»¶
                const filteredFiles = recentFiles.filter(f => f.name !== file.name);

                // æ·»åŠ æ–°æ–‡ä»¶åˆ°å¼€å¤´
                filteredFiles.unshift(newFile);

                // ä¿æŒæœ€å¤§æ•°é‡
                if (filteredFiles.length > MAX_RECENT_FILES) {
                    filteredFiles.pop();
                }

                // å°è¯•ä¿å­˜ï¼Œå¦‚æœå¤±è´¥åˆ™æ¸…ç†æ›´å¤šç©ºé—´
                try {
                    storageUtil.set('recentFiles', filteredFiles);
                    await indexedDBUtil.addFile(file.name, content);
                } catch (e) {
                    console.warn('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œæ­£åœ¨æ¸…ç†...');
                    // å¦‚æœè¿˜æ˜¯å­˜ä¸ä¸‹ï¼Œåˆ™åªä¿ç•™æœ€æ–°çš„æ–‡ä»¶
                    filteredFiles.splice(1);
                    storageUtil.set('recentFiles', filteredFiles);
                    await indexedDBUtil.addFile(file.name, content);
                }

                loadRecentFiles();
            } catch (error) {
                console.error('ä¿å­˜æœ€è¿‘é˜…è¯»è®°å½•å¤±è´¥:', error);
                Swal.fire({
                    title: 'è­¦å‘Š',
                    text: 'ç”±äºæµè§ˆå™¨å­˜å‚¨ç©ºé—´é™åˆ¶ï¼Œæ— æ³•ä¿å­˜å®Œæ•´çš„é˜…è¯»è®°å½•',
                    icon: 'warning'
                });
            }
        }

        // åŠ è½½é˜…è¯»æ–‡ä»¶
        async function loadRecentFile(name) {
            const recentFiles = storageUtil.get('recentFiles', []);
            const file = await indexedDBUtil.getFile(name);

            // æ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´å†…å®¹
            if (!file.content) {
                Swal.fire({
                    title: 'æç¤º',
                    text: 'æ‰¾ä¸åˆ°å†…å®¹',
                    icon: 'info'
                });
                return;
            }

            try {
                toggleLoadingIndicator(true);
                parseChapters(file.content);
                novelName = name; // æ›´æ–°æ–‡ä»¶å
                updateChapterList();
                saveReadingProgress();
            } catch (error) {
                console.error('åŠ è½½æœ€è¿‘æ–‡ä»¶æ—¶å‡ºé”™:', error);
                Swal.fire({
                    title: 'é”™è¯¯',
                    text: 'åŠ è½½æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•',
                    icon: 'error'
                });
            } finally {
                toggleLoadingIndicator(false);
            }
        }

        // è§£æç« èŠ‚
        function parseChapters(text) {
            try {
                // æ˜¾ç¤ºåŠ è½½æç¤º
                toggleLoadingIndicator(true);

                // æ›´å¼ºå¤§çš„ç« èŠ‚åŒ¹é…æ¨¡å¼
                const chapterPattern = /^[ç¬¬]?[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+[ç« èŠ‚å›é›†å·][^\n]*$/gm;
                const lines = text.split('\n');

                chapters = [];
                let currentChapter = {
                    title: '',
                    content: []
                };

                // å¦‚æœç¬¬ä¸€è¡Œä¸æ˜¯ç« èŠ‚æ ‡é¢˜ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤ç« èŠ‚
                if (!lines[0].match(chapterPattern)) {
                    currentChapter.title = 'å¼€å§‹';
                }

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue; // è·³è¿‡ç©ºè¡Œ

                    const isChapterTitle = line.match(chapterPattern);
                    if (isChapterTitle) {
                        if (currentChapter.title) {
                            chapters.push({ ...currentChapter });
                        }
                        currentChapter = {
                            title: line,
                            content: []
                        };
                    } else if (currentChapter.title) {
                        currentChapter.content.push(line);
                    }
                }

                // æ·»åŠ æœ€åä¸€ä¸ªç« èŠ‚
                if (currentChapter.title && currentChapter.content.length > 0) {
                    chapters.push(currentChapter);
                }

                // æ£€æŸ¥æ˜¯å¦æˆåŠŸè§£æåˆ°ç« èŠ‚
                if (chapters.length === 0) {
                    // å¦‚æœæ²¡æœ‰è¯†åˆ«åˆ°ç« èŠ‚ï¼Œå°†æ•´ä¸ªæ–‡æœ¬ä½œä¸ºä¸€ä¸ªç« èŠ‚
                    chapters.push({
                        title: 'å…¨æ–‡',
                        content: lines.filter(line => line.trim())
                    });
                }

                displayChapterList();
                if (chapters.length > 0) {
                    showChapter(0);
                    loadReaderSettings(); // åº”ç”¨ä¿å­˜çš„è®¾ç½®
                }

                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                Swal.fire({
                    title: 'åŠ è½½æˆåŠŸ',
                    text: `å…±è§£æåˆ° ${chapters.length} ä¸ªç« èŠ‚`,
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('è§£ææ–‡ä»¶æ—¶å‡ºé”™:', error);
                Swal.fire({
                    title: 'é”™è¯¯',
                    text: 'æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®',
                    icon: 'error'
                });
            } finally {
                // éšè—åŠ è½½æç¤º
                toggleLoadingIndicator(false);
            }
        }

        // æ˜¾ç¤ºç« èŠ‚åˆ—è¡¨
        function displayChapterList() {
            // ä½†å¦‚æœä¾§è¾¹æ ç›®å½•æ­£åœ¨æ˜¾ç¤ºï¼Œæˆ‘ä»¬åº”è¯¥æ›´æ–°å®ƒ
            const sidebarChapterList = document.getElementById('sidebarChapterList');
            if (sidebarChapterList) {
                sidebarChapterList.innerHTML = '';

                chapters.forEach((chapter, index) => {
                    const li = document.createElement('li');
                    li.className = 'chapter-item';
                    if (index === currentChapterIndex) {
                        li.classList.add('active');
                    }
                    li.textContent = chapter.title;
                    li.onclick = () => {
                        showChapter(index);
                        closeSidebar(); // é€‰æ‹©ç« èŠ‚åå…³é—­ä¾§è¾¹æ 
                    };
                    sidebarChapterList.appendChild(li);
                });

                // æ»šåŠ¨åˆ°å½“å‰ç« èŠ‚ä½ç½®
                setTimeout(() => {
                    const activeItem = sidebarChapterList.querySelector('.chapter-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
        }

        // æ‰“å¼€ç« èŠ‚
        function showChapter(index) {
            // æ£€æŸ¥ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
            if (index < 0 || index >= chapters.length) return;

            currentChapterIndex = index;
            const chapter = chapters[index];

            // å¦‚æœä¾§è¾¹æ ç« èŠ‚åˆ—è¡¨å¯è§ï¼Œæ›´æ–°å…¶æ´»åŠ¨çŠ¶æ€
            const sidebarChapterList = document.getElementById('sidebarChapterList');
            if (sidebarChapterList) {
                const chapterItems = sidebarChapterList.querySelectorAll('.chapter-item');
                chapterItems.forEach((item, idx) => {
                    if (idx === index) {
                        item.classList.add('active');
                        // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM æ›´æ–°åå†æ»šåŠ¨
                        requestAnimationFrame(() => {
                            item.scrollIntoView({
                                behavior: 'smooth',
                                block: 'nearest',
                                inline: 'nearest'
                            });
                        });
                    } else {
                        item.classList.remove('active');
                    }
                });
            }

            // å¦‚æœæ˜¯è‡ªåŠ¨æ‹¼æ¥æ¨¡å¼ï¼Œå…ˆæ¸…é™¤æ‰€æœ‰æ‹¼æ¥çš„ç« èŠ‚
            if (pageMode === 'autoAppend') {
                document.querySelectorAll('.appended-chapter').forEach(el => el.remove());
                // ç¡®ä¿åœ¨è‡ªåŠ¨æ‹¼æ¥æ¨¡å¼ä¸‹éšè—å¯¼èˆªæŒ‰é’®
                document.querySelector('.nav-buttons').style.display = 'none';
            } else {
                // åœ¨éè‡ªåŠ¨æ‹¼æ¥æ¨¡å¼ä¸‹æ˜¾ç¤ºå¯¼èˆªæŒ‰é’®
                document.querySelector('.nav-buttons').style.display = 'flex';
            }

            // æ¸…é™¤å½“å‰å†…å®¹
            const contentText = document.getElementById('contentText');
            const contentTitle = document.getElementById('contentTitle');
            contentText.innerHTML = '';
            contentTitle.textContent = '';

            // æ›´æ–°å†…å®¹
            contentTitle.textContent = chapter.title;
            contentText.innerHTML = chapter.content
                .map(line => `<p>${line}</p>`)
                .join('');

            // æ›´æ–°è¿›åº¦
            updateReadProgress();

            // é‡ç½®å†…å®¹åŒºåŸŸæ»šåŠ¨ä½ç½®
            document.querySelector('.content').scrollTop = 0;

            // ä¿å­˜è¿›åº¦
            saveReadingProgress();
            // ä¿å­˜åˆ°æœ€è¿‘é˜…è¯»ç« èŠ‚
            saveRecentChapter();

            // å¦‚æœåœ¨è‡ªåŠ¨æ‹¼æ¥æ¨¡å¼ä¸‹ï¼Œæ·»åŠ æ»šåŠ¨ç›‘å¬
            if (pageMode === 'autoAppend') {
                const contentElement = document.querySelector('.content');
                // ç¡®ä¿ç›‘å¬å™¨å·²è¢«ç§»é™¤ï¼Œç„¶åé‡æ–°æ·»åŠ 
                contentElement.removeEventListener('scroll', checkScrollPositionForAppend);
                contentElement.addEventListener('scroll', checkScrollPositionForAppend);
            }
        }

        // æ·»åŠ æ–‡ä»¶è¾“å…¥äº‹ä»¶
        function addEventFileInput() {
            const fileInput = document.getElementById('sidebarFileInput');
            const newFileInput = fileInput.cloneNode(true);

            fileInput.parentNode.replaceChild(newFileInput, fileInput); // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            newFileInput.addEventListener('change', async function (e) {
                const file = e.target.files[0];
                if (!file) return;

                // æ˜¾ç¤ºåŠ è½½æç¤º
                toggleLoadingIndicator(true);
                closeSidebar(); // å…³é—­ä¾§è¾¹æ 

                try {
                    // éªŒè¯æ–‡ä»¶
                    validateFile(file);

                    // å…ˆå°è¯•æ£€æµ‹æ–‡ä»¶ç¼–ç 
                    const buffer = await file.arrayBuffer();
                    const encoding = detectEncoding(new Uint8Array(buffer));

                    // ä½¿ç”¨åˆ†å—è¯»å–
                    const text = await readFileInChunks(file, encoding);

                    if (!text || text.length === 0) {
                        throw new Error('æ–‡ä»¶å†…å®¹ä¸ºç©º');
                    }

                    addRecentFile(file, text);
                    parseChapters(text);
                } catch (error) {
                    console.error('æ–‡ä»¶å¤„ç†é”™è¯¯:', error);
                    toggleLoadingIndicator(false);
                    // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    Swal.fire({
                        title: 'é”™è¯¯',
                        text: error.message || 'æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•',
                        icon: 'error'
                    });
                } finally {
                    toggleLoadingIndicator(false);
                }
            });
        }

        // æ„å»ºæ–‡ä»¶åˆ—è¡¨
        function loadRecentFiles() {
            const recentFiles = storageUtil.get('recentFiles', []);
            const recentList = document.getElementById('sidebarRecentList');
            recentList.innerHTML = '';

            recentFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'recent-item';
                li.innerHTML = `
                    <div class="recent-item-content" onclick="loadRecentFile('${file.name}')">
                        <span class="recent-item-title">${file.name}</span>
                        <span class="recent-item-time">${formatTime(file.time)}</span>
                    </div>
                    <button class="delete-btn" onclick="deleteRecentFile(${index})" title="åˆ é™¤">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                        </svg>
                    </button>
                `;
                recentList.appendChild(li);
            });
        }

        // æ˜¾ç¤ºæ–‡ä»¶è¾“å…¥ç•Œé¢
        function showFileInput() {
            openSidebar('æ‰“å¼€æ–‡ä»¶', 'fileInput');
        }
        //#endregion

        //#region ç« èŠ‚åˆ—è¡¨
        // æ·»åŠ æœç´¢äº‹ä»¶
        function addEventChapterSearch() {
            const chapterList = document.getElementById('sidebarChapterList');
            const searchInput = document.getElementById('chapterSearchInput');

            const newSearchInput = searchInput.cloneNode(true);

            searchInput.parentNode.replaceChild(newSearchInput, searchInput); // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            newSearchInput.addEventListener('input', function (e) {
                const searchText = e.target.value.toLowerCase();
                const items = chapterList.querySelectorAll('li');

                items.forEach((item, index) => {
                    const chapterTitle = chapters[index].title.toLowerCase();
                    if (searchText === '' || chapterTitle.includes(searchText)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // æ›´æ–°ç« èŠ‚åˆ—è¡¨
        function updateChapterList() {
            const searchInput = document.getElementById('chapterSearchInput');
            searchInput.value = ''; // æ¸…ç©ºæœç´¢æ¡†

            const chapterList = document.getElementById('sidebarChapterList');
            chapterList.innerHTML = ''; // æ¸…ç©ºç« èŠ‚åˆ—è¡¨

            // éå†æ’å…¥ç« èŠ‚åˆ—è¡¨
            chapters.forEach((chapter, index) => {
                const li = document.createElement('li');
                li.className = 'chapter-item';
                if (index === currentChapterIndex) {
                    li.classList.add('active');
                }
                li.textContent = chapter.title;
                li.onclick = () => {
                    showChapter(index);
                    closeSidebar(); // é€‰æ‹©ç« èŠ‚åå…³é—­ä¾§è¾¹æ 
                };
                chapterList.appendChild(li);
            });

        }

        // æ˜¾ç¤ºç« èŠ‚åˆ—è¡¨
        function showChapterList() {
            openSidebar('ç« èŠ‚ç›®å½•', 'chapterList'); // æ‰“å¼€ä¾§è¾¹æ ï¼Œæ˜¾ç¤ºç« èŠ‚åˆ—è¡¨é¢æ¿

            const chapterList = document.getElementById('sidebarChapterList'); // åœ¨ä¾§è¾¹æ ä¸­æ˜¾ç¤ºç« èŠ‚åˆ—è¡¨

            // æ»šåŠ¨åˆ°å½“å‰ç« èŠ‚ä½ç½®
            setTimeout(() => {
                const activeItem = chapterList.querySelector('.chapter-item.active');
                if (activeItem) {
                    activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
        //#endregion

        //#region è‡ªåŠ¨æ‹¼æ¥æ¨¡å¼
        // å¯ç”¨è‡ªåŠ¨æ‹¼æ¥æ¨¡å¼
        function enableAutoAppendMode() {
            // å¦‚æœå·²ç»æ˜¯è‡ªåŠ¨æ‹¼æ¥æ¨¡å¼ï¼Œä¸éœ€è¦å†æ¬¡è®¾ç½®
            if (pageMode === 'autoAppend') return;

            // ä¿å­˜å½“å‰æ¨¡å¼
            pageMode = 'autoAppend';

            // æ¸…é™¤å·²æ‹¼æ¥çš„ç« èŠ‚å†…å®¹
            document.querySelectorAll('.appended-chapter').forEach(el => {
                el.remove();
            });

            // æ·»åŠ æ»šåŠ¨ç›‘å¬
            const contentElement = document.querySelector('.content');
            contentElement.addEventListener('scroll', checkScrollPositionForAppend);

            // éšè—ç¿»é¡µæŒ‰é’® - å§‹ç»ˆéšè—
            document.querySelector('.nav-buttons').style.display = 'none';

            // å¦‚æœå·²ç»æ»šåŠ¨åˆ°ä¸€å®šä½ç½®ï¼Œå°±åŠ è½½ä¸‹ä¸€ç« 
            checkScrollPositionForAppend();
        }

        // ç¦ç”¨è‡ªåŠ¨æ‹¼æ¥æ¨¡å¼
        function disableAutoAppendMode() {
            // å¦‚æœå·²ç»æ˜¯æŒ‰é’®æ¨¡å¼ï¼Œä¸éœ€è¦å†æ¬¡è®¾ç½®
            if (pageMode !== 'autoAppend') return;

            // ä¿å­˜å½“å‰æ¨¡å¼
            pageMode = 'button';

            // è®°ä½å½“å‰ç« èŠ‚ç´¢å¼•
            const currentIndex = currentChapterIndex;

            // ç§»é™¤æ»šåŠ¨ç›‘å¬
            const contentElement = document.querySelector('.content');
            contentElement.removeEventListener('scroll', checkScrollPositionForAppend);

            // æ˜¾ç¤ºç¿»é¡µæŒ‰é’® - å§‹ç»ˆæ˜¾ç¤º
            document.querySelector('.nav-buttons').style.display = 'flex';

            // å®Œå…¨ç§»é™¤å·²æ‹¼æ¥çš„ç« èŠ‚
            document.querySelectorAll('.appended-chapter').forEach(el => {
                el.remove();
            });

            // é‡æ–°æ˜¾ç¤ºå½“å‰ç« èŠ‚ï¼Œé¿å…å†…å®¹ä¸¢å¤±
            showChapter(currentIndex);
        }

        // æ£€æŸ¥æ»šåŠ¨ä½ç½®å¹¶åœ¨éœ€è¦æ—¶æ·»åŠ ä¸‹ä¸€ç« 
        function checkScrollPositionForAppend() {
            // åªåœ¨è‡ªåŠ¨æ‹¼æ¥æ¨¡å¼ä¸‹æ‰§è¡Œ
            if (pageMode !== 'autoAppend') return;

            const contentElement = document.querySelector('.content');
            const scrollPosition = contentElement.scrollTop;
            const scrollHeight = contentElement.scrollHeight;
            const clientHeight = contentElement.clientHeight;

            // å½“è·ç¦»åº•éƒ¨å°äº600åƒç´ æ—¶ï¼ŒåŠ è½½ä¸‹ä¸€ç« ï¼Œæå‰åŠ è½½æé«˜ç”¨æˆ·ä½“éªŒ
            if (scrollHeight - scrollPosition - clientHeight < 600) {
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€ç« ä¸”ä¸‹ä¸€ç« å°šæœªè¢«åŠ è½½
                if (currentChapterIndex < chapters.length - 1 &&
                    !document.getElementById(`chapter-${currentChapterIndex + 1}`)) {
                    appendNextChapter();
                }
            }
        }

        // å°†ä¸‹ä¸€ç« æ‹¼æ¥åˆ°å½“å‰å†…å®¹ä¸‹æ–¹
        function appendNextChapter() {
            try {
                // ç¡®ä¿æœ‰ä¸‹ä¸€ç« 
                if (currentChapterIndex >= chapters.length - 1) return;

                // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½äº†è¿™ä¸€ç« 
                const nextChapterIndex = currentChapterIndex + 1;
                if (document.getElementById(`chapter-${nextChapterIndex}`)) return;

                const nextChapter = chapters[nextChapterIndex];

                // æ£€æŸ¥ç« èŠ‚å†…å®¹æ˜¯å¦æœ‰æ•ˆ
                if (!nextChapter || !nextChapter.content || nextChapter.content.length === 0) {
                    console.error("ä¸‹ä¸€ç« èŠ‚å†…å®¹æ— æ•ˆï¼Œè·³è¿‡æ‹¼æ¥");
                    return;
                }

                // åˆ›å»ºæ–‡æ¡£ç‰‡æ®µï¼Œæé«˜æ€§èƒ½
                const fragment = document.createDocumentFragment();

                // åˆ›å»ºç« èŠ‚å®¹å™¨ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç®¡ç†
                const chapterContainer = document.createElement('div');
                chapterContainer.className = 'appended-chapter-container';
                chapterContainer.dataset.chapterIndex = nextChapterIndex;

                // åˆ›å»ºç« èŠ‚æ ‡é¢˜
                const titleElement = document.createElement('h3');
                titleElement.className = 'content-title appended-chapter';
                titleElement.id = `chapter-${nextChapterIndex}-title`;
                titleElement.textContent = nextChapter.title;
                chapterContainer.appendChild(titleElement);

                // åˆ›å»ºç« èŠ‚å†…å®¹
                const contentElement = document.createElement('div');
                contentElement.className = 'content-text appended-chapter';
                contentElement.id = `chapter-${nextChapterIndex}`;

                // ä¸ºé˜²æ­¢DOMæ“ä½œè¿‡å¤šï¼Œä½¿ç”¨innerHTMLä¸€æ¬¡æ€§è®¾ç½®å†…å®¹
                contentElement.innerHTML = nextChapter.content
                    .map(line => `<p>${line}</p>`)
                    .join('');
                chapterContainer.appendChild(contentElement);

                // è·å–å½“å‰è®¾ç½®å¹¶åº”ç”¨åˆ°æ–°ç« èŠ‚
                const settings = storageUtil.get('readerSettings') || {
                    fontSize: '18',
                    lineHeight: '1.8',
                    fontFamily: 'Noto Serif SC'
                };

                // åº”ç”¨æ ·å¼åˆ°æ–°ç« èŠ‚å†…å®¹
                contentElement.style.fontSize = `${settings.fontSize}px`;
                contentElement.style.lineHeight = settings.lineHeight;
                contentElement.style.fontFamily = settings.fontFamily;

                // å°†ç« èŠ‚å®¹å™¨æ·»åŠ åˆ°æ–‡æ¡£ç‰‡æ®µ
                fragment.appendChild(chapterContainer);

                // å°†æ–°ç« èŠ‚æ·»åŠ åˆ°å†…å®¹åŒºåŸŸ
                const contentArea = document.querySelector('.content');
                contentArea.appendChild(fragment);

                // æ›´æ–°å½“å‰ç« èŠ‚ç´¢å¼•
                currentChapterIndex = nextChapterIndex;

                // æ›´æ–°ä¾§è¾¹æ ç« èŠ‚åˆ—è¡¨çš„æ´»åŠ¨çŠ¶æ€
                updateChapterListActiveState(nextChapterIndex);

                // æ›´æ–°è¿›åº¦
                updateReadProgress();

                // ä¿å­˜é˜…è¯»è¿›åº¦
                saveReadingProgress();
                saveRecentChapter();

                // å†…å­˜ç®¡ç†ï¼šå¦‚æœæ‹¼æ¥çš„ç« èŠ‚è¿‡å¤šï¼Œå¯ä»¥ç§»é™¤è¾ƒæ—©çš„ç« èŠ‚
                managePrependedChapters();
            } catch (error) {
                console.error("æ‹¼æ¥ç« èŠ‚æ—¶å‡ºé”™:", error);
            }
        }

        // æ›´æ–°ç« èŠ‚åˆ—è¡¨çš„æ´»åŠ¨çŠ¶æ€
        function updateChapterListActiveState(activeIndex) {
            const sidebarChapterList = document.getElementById('sidebarChapterList');
            if (sidebarChapterList) {
                const items = sidebarChapterList.querySelectorAll('.chapter-item');
                items.forEach((item, idx) => {
                    if (idx === activeIndex) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
        }

        // ç®¡ç†å·²æ‹¼æ¥çš„ç« èŠ‚ï¼Œé˜²æ­¢å†…å­˜å ç”¨è¿‡å¤§
        function managePrependedChapters() {
            const MAX_APPENDED_CHAPTERS = 5; // æœ€å¤šä¿ç•™5ä¸ªæ‹¼æ¥ç« èŠ‚
            const containers = document.querySelectorAll('.appended-chapter-container');

            // å¦‚æœæ‹¼æ¥çš„ç« èŠ‚æ•°è¶…è¿‡æœ€å¤§å€¼ï¼Œç§»é™¤æœ€æ—©çš„ç« èŠ‚å®¹å™¨
            if (containers.length > MAX_APPENDED_CHAPTERS) {
                // è·å–æœ€æ—©æ·»åŠ çš„ç« èŠ‚å®¹å™¨ï¼ˆDOMä¸­çš„ç¬¬ä¸€ä¸ªï¼‰
                const oldestContainer = containers[0];

                // å®‰å…¨ç§»é™¤ï¼šç¡®ä¿å…ƒç´ å­˜åœ¨æ‰åˆ é™¤
                if (oldestContainer) {
                    oldestContainer.remove();
                }
            }
        }
        //#endregion

        document.getElementById('prevChapter').onclick = () => showChapter(currentChapterIndex - 1);
        document.getElementById('nextChapter').onclick = () => showChapter(currentChapterIndex + 1);

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        document.querySelector('.content').addEventListener('scroll', debounce(() => {
            saveReadingProgress();
        }, 500));

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            loadRecentFiles(); // æ„å»ºæ–‡ä»¶åˆ—è¡¨
            showShortcutTip(); // æ˜¾ç¤ºå¿«æ·æç¤º
            loadReaderSettings(); // åŠ è½½é˜…è¯»é…ç½®
            restoreReadingProgress(); // æ¢å¤ä¸Šæ¬¡çš„é˜…è¯»è¿›åº¦

            // é¡µé¢åŠ è½½æ—¶æ¢å¤ç›®å½•çŠ¶æ€
            const isCollapsed = storageUtil.get('chaptersCollapsed') === 'true';
            if (isCollapsed) {
                document.querySelector('.chapters').classList.add('collapsed');
            }

            addEventFileInput(); // æ·»åŠ æ–‡ä»¶è¾“å…¥äº‹ä»¶
            addEventChapterSearch(); // æ·»åŠ æœç´¢äº‹ä»¶

            startReadingTimer(); // é¡µé¢åŠ è½½æ—¶æ¢å¤é˜…è¯»æ—¶é—´
            showReadingTime(); // æ„å»ºé˜…è¯»æ—¶é—´

            generateThemeList() // æ„å»ºä¸»é¢˜åˆ—è¡¨
        });
    </script>
</body>

</html>